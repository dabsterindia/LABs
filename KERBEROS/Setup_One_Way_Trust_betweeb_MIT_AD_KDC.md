# Setup One Way Trust between MIT KDC & Active Directory

### Environment details:
```
MIT REALM = MIT.HORTONWORKS.COM
AD REALM = HWX.COM
MIT HOSTNAME = hdp3.europe-west2-c.c.x-plateau-236613.internal
AD HOSTNAME = adserver.asia-south1-c.c.x-plateau-236613.internal
```

### Prerequisites
- [x] Cluster should be kerberized with MIT KDC
- [x] You should have MIT KDC admin credentials (we are using admin/admin here)
- [x] AD admin privileges to setup trust (see step 1)

### > STEP 1: Setup Trust in AD (Peform these steps on AD)
#### >> 1. Login your Active Directory with a user having with ___Administrator privileges___

##### Execute following commands in PowerShell

##### >> 1.1 : Create a KDC definition in Active Directory
```
ksetup /addkdc MIT.HORTONWORKS.COM hdp3.europe-west2-c.c.x-plateau-236613.internal
```

##### >> 1.2 : Create the Trust in Active Directory

___Important:___ The password used here will be used later in the MIT KDC configuration of the trust:

```
netdom trust MIT.HORTONWORKS.COM /Domain:HWX.COM /add /realm /passwordt:Hadoop@123
```

##### >> 1.3 : Specify Encryption Types in Active Directory
```
ksetup /SetEncTypeAttr MIT.HORTONWORKS.COM AES256-CTS-HMAC-SHA1-96 AES128-CTS-HMAC-SHA1-96 RC4-HMAC-MD5 DES-CBC-MD5 DES-CBC-CRC
```
_In order for the MIT realm to trust tickets generated by the AD KDC, the encryption types between both KDCs must be compatible. This means that there must be at least one encryption type that is accepted by both the AD server as well as the MIT KDC server._


![alt text](https://github.com/dabsterindia/LABs/blob/master/tmp/images/httpd-test-webpage.png)

### STEP 2: Setup Trust on MIT (Perform these steps on MIT KDC host)
##### Login to MID KDC host and add a principal combining the realms.
___Important:___ The password for this user must be the same as the password used to create the trust on the AD server in step 1.2

```
kinit admin/admin@MIT.HORTONWORKS.COM
kadmin -q "addprinc krbtgt/MIT.HORTONWORKS.COM@HWX.COM"
```

### STEP 3: Configure HDP

#### 3.1 : Specify Encryption Types & Add AD REALM in krb5

Goto Ambari > Kerberos > Configs > Advanced krb5-conf

- Add below encryption types in [libdefaults] section

```
permitted_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96 arcfour-hmac-md5 des-cbc-crc des-cbc-md5
```
- Add below lined in [realms] section (Do not remove existing REALM section)
```
HWX.COM = {
  kdc = adserver.asia-south1-c.c.x-plateau-236613.internal
  admin_server = adserver.asia-south1-c.c.x-plateau-236613.internal
  default_domain = adserver.asia-south1-c.c.x-plateau-236613.internal
  }
```

__EXAMPLE krb5.com:__
```
[libdefaults]
  renew_lifetime = 7d
  forwardable = true
  default_realm = {{realm}}
  ticket_lifetime = 24h
  dns_lookup_realm = false
  dns_lookup_kdc = false
  default_ccache_name = /tmp/krb5cc_%{uid}
  #default_tgs_enctypes = {{encryption_types}}
  #default_tkt_enctypes = {{encryption_types}}
  permitted_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96 arcfour-hmac-md5 des-cbc-crc des-cbc-md5

{% if domains %}
[domain_realm]
{%- for domain in domains.split(',') %}
  {{domain|trim()}} = {{realm}}
{%- endfor %}
{% endif %}
[logging]
  default = FILE:/var/log/krb5kdc.log
  admin_server = FILE:/var/log/kadmind.log
  kdc = FILE:/var/log/krb5kdc.log

[realms]
  {{realm}} = {
{%- if master_kdc %}
    master_kdc = {{master_kdc|trim()}}
{%- endif -%}
{%- if kdc_hosts > 0 -%}
{%- set kdc_host_list = kdc_hosts.split(',')  -%}
{%- if kdc_host_list and kdc_host_list|length > 0 %}
    admin_server = {{admin_server_host|default(kdc_host_list[0]|trim(), True)}}
{%- if kdc_host_list -%}
{%- if master_kdc and (master_kdc not in kdc_host_list) %}
    kdc = {{master_kdc|trim()}}
{%- endif -%}
{% for kdc_host in kdc_host_list %}
    kdc = {{kdc_host|trim()}}
{%- endfor -%}
{% endif %}
{%- endif %}
{%- endif %}
  }
HWX.COM = {
  kdc = adserver.asia-south1-c.c.x-plateau-236613.internal
  admin_server = adserver.asia-south1-c.c.x-plateau-236613.internal
  default_domain = adserver.asia-south1-c.c.x-plateau-236613.internal
  }
```

##### 3.2 : Configure _auth_to_local_ RULE's to convert AD principal to a username

Goto Ambari > HDFS > Configs > Advanced

- Add below RULEs in _hadoop.security.auth_to_local_ property
```
RULE:[1:$1@$0](^.*@HWX\.COM$)s/^(.*)@HWX\.COM$/$1/g
RULE:[2:$1@$0](^.*@HWX\.COM$)s/^(.*)@HWX\.COM$/$1/g
```
#### Step 4: Validate setup

##### 4.1 : Run below command and see if it converts principal with @HWX.COM to a username
hadoop org.apache.hadoop.security.HadoopKerberosName <aduser>@HWX.COM

Example output:
```
# hadoop org.apache.hadoop.security.HadoopKerberosName dabster@HWX.COM
Name: dabster@HWX.COM to dabster
```
##### 4.2 : kinit with AD user and access hadoop
```
[root@hdp3 kerberos]# kinit dabster@HWX.COM
Password for dabster@HWX.COM:
[root@hdp3 kerberos]#
[root@hdp3 kerberos]# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: dabster@HWX.COM

Valid starting       Expires              Service principal
08/17/2019 15:57:21  08/18/2019 01:57:21  krbtgt/HWX.COM@HWX.COM
	renew until 08/24/2019 15:57:17
[root@hdp3 kerberos]# hadoop fs -ls /
Found 8 items
drwxrwxrwt   - yarn   hadoop          0 2019-08-06 11:21 /app-logs
drwxr-xr-x   - yarn   hadoop          0 2019-08-06 11:17 /ats
drwxr-xr-x   - hdfs   hdfs            0 2019-08-06 11:18 /atsv2
drwxr-xr-x   - hdfs   hdfs            0 2019-08-06 11:17 /hdp
drwxr-xr-x   - mapred hdfs            0 2019-08-06 11:17 /mapred
drwxrwxrwx   - mapred hadoop          0 2019-08-06 11:17 /mr-history
drwxrwxrwx   - hdfs   hdfs            0 2019-08-17 15:07 /tmp
drwxr-xr-x   - hdfs   hdfs            0 2019-08-06 11:17 /user

```

